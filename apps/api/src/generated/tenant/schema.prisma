// Prisma schema for Tenant DB (per company)

generator client {
  provider = "prisma-client-js"
  output   = "../../../apps/api/src/generated/tenant"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String       @id @default(uuid())
  email               String       @unique
  passwordHash        String
  fullName            String
  role                Role
  status              String       @default("active")
  lastLoginAt         DateTime?
  sales               Sale[]
  stockEntriesCreated StockEntry[]
}

enum Role {
  super_admin
  pdg
  dg
  employee
}

model Boutique {
  id      String  @id @default(uuid())
  name    String
  code    String  @unique
  address String?
  city    String?
  country String?
  stocks  Stock[]
  sales   Sale[]
}

model Product {
  id              String           @id @default(uuid())
  sku             String           @unique
  name            String
  category        String?
  price           Decimal          @db.Decimal(10, 2)
  cost            Decimal          @db.Decimal(10, 2)
  barcode         String?
  taxRate         Decimal          @db.Decimal(5, 2)
  isActive        Boolean          @default(true)
  stocks          Stock[]
  saleItems       SaleItem[]
  stockEntryItems StockEntryItem[]
}

model Stock {
  id         String   @id @default(uuid())
  boutique   Boutique @relation(fields: [boutiqueId], references: [id])
  boutiqueId String
  product    Product  @relation(fields: [productId], references: [id])
  productId  String
  quantity   Int

  @@unique([boutiqueId, productId])
}

model Supplier {
  id          String       @id @default(uuid())
  name        String
  contactName String?
  phone       String?
  email       String?
  address     String?
  entries     StockEntry[]
}

model StockEntry {
  id              String           @id @default(uuid())
  supplier        Supplier?        @relation(fields: [supplierId], references: [id])
  supplierId      String?
  reference       String?
  createdBy       User             @relation(fields: [createdByUserId], references: [id])
  createdByUserId String
  createdAt       DateTime         @default(now())
  items           StockEntryItem[]
}

model StockEntryItem {
  id           String     @id @default(uuid())
  stockEntry   StockEntry @relation(fields: [stockEntryId], references: [id])
  stockEntryId String
  product      Product    @relation(fields: [productId], references: [id])
  productId    String
  quantity     Int
  unitCost     Decimal    @db.Decimal(10, 2)
}

model Sale {
  id            String     @id @default(uuid())
  boutique      Boutique   @relation(fields: [boutiqueId], references: [id])
  boutiqueId    String
  cashier       User       @relation(fields: [cashierUserId], references: [id])
  cashierUserId String
  total         Decimal    @db.Decimal(10, 2)
  paymentMethod String
  currency      String     @default("GNF")
  createdAt     DateTime   @default(now())
  offlineId     String?    @unique
  status        String     @default("completed")
  items         SaleItem[]
  payments      Payment[]
}

model SaleItem {
  id        String  @id @default(uuid())
  sale      Sale    @relation(fields: [saleId], references: [id])
  saleId    String
  product   Product @relation(fields: [productId], references: [id])
  productId String
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  discount  Decimal @default(0) @db.Decimal(10, 2)
}

model Payment {
  id        String  @id @default(uuid())
  sale      Sale    @relation(fields: [saleId], references: [id])
  saleId    String
  method    String
  amount    Decimal @db.Decimal(10, 2)
  reference String?
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String?
  role       String?
  action     String
  resource   String
  resourceId String?
  metadata   Json?
  ip         String?
  createdAt  DateTime @default(now())
}
